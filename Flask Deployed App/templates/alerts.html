{% extends 'base.html' %}
{% block pagetitle %}Community Alerts{% endblock pagetitle %}

{% block body %}
<style>
    .alerts-hero {
        text-align: center;
        padding: 40px 0 30px;
    }

    .alerts-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #fff;
        text-shadow: 2px 2px 15px rgba(0, 0, 0, 0.3);
        margin-bottom: 10px;
    }

    .alerts-subtitle {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.9);
    }

    .map-card {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        margin-bottom: 30px;
    }

    #alert-map {
        width: 100%;
        height: 450px;
    }

    .map-controls {
        padding: 20px 25px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        align-items: center;
        border-bottom: 1px solid #eee;
    }

    .search-input {
        flex: 1;
        min-width: 200px;
        padding: 10px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 50px;
        font-family: 'Poppins', sans-serif;
        font-size: 0.95rem;
        outline: none;
        transition: border-color 0.3s ease;
    }

    .search-input:focus {
        border-color: #4ECC5A;
    }

    .btn-locate {
        background: linear-gradient(135deg, #4ECC5A, #2d8f4e);
        color: #fff;
        border: none;
        padding: 10px 25px;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-locate:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(78, 204, 90, 0.4);
    }

    .alerts-list {
        padding: 25px;
    }

    .alerts-list h4 {
        font-size: 1.2rem;
        font-weight: 700;
        color: #1a5c2e;
        margin-bottom: 20px;
    }

    .alert-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
    }

    .alert-card {
        background: #f8fff8;
        border-radius: 15px;
        padding: 20px;
        border-left: 4px solid #4ECC5A;
        transition: all 0.3s ease;
    }

    .alert-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .alert-card.severity-critical { border-left-color: #e74c3c; }
    .alert-card.severity-moderate { border-left-color: #f39c12; }
    .alert-card.severity-mild { border-left-color: #f1c40f; }
    .alert-card.severity-healthy { border-left-color: #27ae60; }

    .alert-disease {
        font-weight: 700;
        font-size: 1rem;
        color: #1a5c2e;
        margin-bottom: 5px;
    }

    .alert-meta {
        font-size: 0.85rem;
        color: #888;
        margin-bottom: 8px;
    }

    .alert-severity-badge {
        display: inline-block;
        padding: 3px 12px;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .alert-severity-badge.critical { background: #fde8e8; color: #e74c3c; }
    .alert-severity-badge.moderate { background: #fef3e2; color: #f39c12; }
    .alert-severity-badge.mild { background: #fef9e7; color: #b7950b; }
    .alert-severity-badge.healthy { background: #e8f8e8; color: #27ae60; }

    .alert-confidence {
        font-size: 0.85rem;
        color: #555;
    }

    .subscribe-card {
        background: rgba(255, 255, 255, 0.98);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
        text-align: center;
    }

    .subscribe-card h4 {
        font-weight: 700;
        color: #1a5c2e;
        margin-bottom: 10px;
    }

    .subscribe-card p {
        color: #666;
        margin-bottom: 20px;
    }

    .subscribe-form {
        display: flex;
        gap: 10px;
        justify-content: center;
        flex-wrap: wrap;
        max-width: 600px;
        margin: 0 auto;
    }

    .subscribe-form input {
        flex: 1;
        min-width: 180px;
        padding: 10px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 50px;
        font-family: 'Poppins', sans-serif;
        outline: none;
        transition: border-color 0.3s ease;
    }

    .subscribe-form input:focus {
        border-color: #4ECC5A;
    }

    .btn-subscribe {
        background: linear-gradient(135deg, #4ECC5A, #2d8f4e);
        color: #fff;
        border: none;
        padding: 10px 30px;
        border-radius: 50px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-subscribe:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(78, 204, 90, 0.4);
    }

    .subscribe-msg {
        margin-top: 10px;
        font-size: 0.9rem;
        display: none;
    }

    .no-alerts {
        text-align: center;
        padding: 40px;
        color: #999;
    }

    .no-alerts i {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
    }

    .loading-spinner {
        text-align: center;
        padding: 40px;
    }

    @media (max-width: 768px) {
        .alerts-title { font-size: 1.8rem; }
        #alert-map { height: 300px; }
        .alert-cards { grid-template-columns: 1fr; }
    }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<div class="container">
    <!-- Hero -->
    <div class="alerts-hero fade-in">
        <h1 class="alerts-title" data-translatable>Community Disease Alerts</h1>
        <p class="alerts-subtitle" data-translatable>Track and report plant disease outbreaks in your area</p>
    </div>

    <!-- Map Card -->
    <div class="map-card fade-in">
        <div class="map-controls">
            <input type="text" id="region-filter" class="search-input"
                   placeholder="Filter by region name..." />
            <button class="btn-locate" onclick="filterAlerts()">
                <i class="fas fa-search"></i> Search
            </button>
            <button class="btn-locate" onclick="locateMe()">
                <i class="fas fa-crosshairs"></i> Near Me
            </button>
        </div>
        <div id="alert-map"></div>

        <!-- Alert List -->
        <div class="alerts-list">
            <h4 data-translatable>Recent Reports</h4>
            <div id="alerts-container">
                <div class="loading-spinner">
                    <div class="spinner-custom" style="margin: 0 auto;"></div>
                    <p style="color: #888; margin-top: 15px;">Loading alerts...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscribe -->
    <div class="subscribe-card fade-in" style="margin-bottom: 40px;">
        <h4 data-translatable>Get Notified</h4>
        <p data-translatable>Subscribe to receive email alerts when diseases are reported in your region</p>
        <div class="subscribe-form">
            <input type="email" id="sub-email" placeholder="Your email address" />
            <input type="text" id="sub-region" placeholder="Region name" />
            <button class="btn-subscribe" onclick="subscribe()">
                <i class="fas fa-bell me-2"></i>Subscribe
            </button>
        </div>
        <p id="subscribe-msg" class="subscribe-msg"></p>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map = L.map('alert-map').setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var markers = [];
    var allAlerts = [];

    var SEVERITY_COLORS = {
        'Critical': '#e74c3c',
        'Moderate': '#f39c12',
        'Mild': '#f1c40f',
        'Healthy': '#27ae60'
    };

    function loadAlerts(region) {
        var url = '/api/alerts';
        if (region) url += '?region=' + encodeURIComponent(region);

        fetch(url)
            .then(function(res) { return res.json(); })
            .then(function(data) {
                allAlerts = data.alerts || [];
                renderAlerts(allAlerts);
                renderMarkers(allAlerts);
            })
            .catch(function(err) {
                console.error('Failed to load alerts:', err);
                var container = document.getElementById('alerts-container');
                container.textContent = '';
                var div = document.createElement('div');
                div.className = 'no-alerts';
                var icon = document.createElement('i');
                icon.className = 'fas fa-exclamation-triangle';
                div.appendChild(icon);
                var p = document.createElement('p');
                p.textContent = 'Failed to load alerts. The database may not be configured yet.';
                div.appendChild(p);
                container.appendChild(div);
            });
    }

    function renderMarkers(alerts) {
        markers.forEach(function(m) { map.removeLayer(m); });
        markers = [];

        alerts.forEach(function(alert) {
            if (!alert.latitude || !alert.longitude) return;

            var color = SEVERITY_COLORS[alert.severity] || '#999';
            var icon = L.divIcon({
                className: 'custom-marker',
                html: '<div style="width:14px;height:14px;border-radius:50%;background:' + color +
                      ';border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>',
                iconSize: [14, 14],
                iconAnchor: [7, 7]
            });

            var m = L.marker([alert.latitude, alert.longitude], { icon: icon }).addTo(map);

            var popupContent = document.createElement('div');
            var b = document.createElement('b');
            b.textContent = alert.disease_name;
            popupContent.appendChild(b);
            popupContent.appendChild(document.createElement('br'));

            var sev = document.createElement('span');
            sev.textContent = alert.severity + ' | ' + alert.confidence + '% confidence';
            popupContent.appendChild(sev);
            popupContent.appendChild(document.createElement('br'));

            var reg = document.createElement('small');
            reg.textContent = alert.region_name || 'Unknown location';
            popupContent.appendChild(reg);

            m.bindPopup(popupContent);
            markers.push(m);
        });

        if (markers.length > 0) {
            var group = L.featureGroup(markers);
            map.fitBounds(group.getBounds().pad(0.2));
        }
    }

    function renderAlerts(alerts) {
        var container = document.getElementById('alerts-container');
        container.textContent = '';

        if (!alerts.length) {
            var noDiv = document.createElement('div');
            noDiv.className = 'no-alerts';
            var icon = document.createElement('i');
            icon.className = 'fas fa-check-circle';
            noDiv.appendChild(icon);
            var p = document.createElement('p');
            p.textContent = 'No disease alerts reported yet. The community is doing great!';
            noDiv.appendChild(p);
            container.appendChild(noDiv);
            return;
        }

        var grid = document.createElement('div');
        grid.className = 'alert-cards';

        alerts.forEach(function(alert) {
            var card = document.createElement('div');
            card.className = 'alert-card severity-' + (alert.severity || 'moderate').toLowerCase();

            var name = document.createElement('div');
            name.className = 'alert-disease';
            name.textContent = alert.disease_name;
            card.appendChild(name);

            var meta = document.createElement('div');
            meta.className = 'alert-meta';
            var region = alert.region_name || 'Unknown';
            var date = alert.created_at ? new Date(alert.created_at).toLocaleDateString() : '';
            meta.textContent = region + (date ? ' \u2022 ' + date : '');
            card.appendChild(meta);

            var badge = document.createElement('span');
            badge.className = 'alert-severity-badge ' + (alert.severity || 'moderate').toLowerCase();
            badge.textContent = alert.severity || 'Unknown';
            card.appendChild(badge);

            var conf = document.createElement('span');
            conf.className = 'alert-confidence';
            conf.textContent = '  ' + alert.confidence + '% confidence';
            card.appendChild(conf);

            grid.appendChild(card);
        });

        container.appendChild(grid);
    }

    function filterAlerts() {
        var region = document.getElementById('region-filter').value.trim();
        loadAlerts(region);
    }

    function locateMe() {
        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser.');
            return;
        }

        navigator.geolocation.getCurrentPosition(
            function(pos) {
                map.setView([pos.coords.latitude, pos.coords.longitude], 10);

                L.circleMarker([pos.coords.latitude, pos.coords.longitude], {
                    radius: 10,
                    color: '#4ECC5A',
                    fillColor: '#4ECC5A',
                    fillOpacity: 0.5
                }).addTo(map).bindPopup('You are here').openPopup();
            },
            function() {
                alert('Unable to get your location.');
            }
        );
    }

    function subscribe() {
        var email = document.getElementById('sub-email').value.trim();
        var region = document.getElementById('sub-region').value.trim();
        var msg = document.getElementById('subscribe-msg');

        if (!email || !region) {
            msg.textContent = 'Please enter both email and region.';
            msg.style.color = '#e74c3c';
            msg.style.display = 'block';
            return;
        }

        fetch('/api/subscribe', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email, region_name: region })
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            if (data.success) {
                msg.textContent = 'Subscribed successfully! You will receive alerts for ' + region + '.';
                msg.style.color = '#27ae60';
            } else {
                msg.textContent = data.error || 'Subscription failed.';
                msg.style.color = '#e74c3c';
            }
            msg.style.display = 'block';
        })
        .catch(function() {
            msg.textContent = 'Network error. Please try again.';
            msg.style.color = '#e74c3c';
            msg.style.display = 'block';
        });
    }

    // Enter key in region filter
    document.getElementById('region-filter').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') filterAlerts();
    });

    // Load on page ready
    document.addEventListener('DOMContentLoaded', function() {
        loadAlerts('');
    });
</script>

{% endblock body %}
